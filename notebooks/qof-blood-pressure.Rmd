---
title: "Trends in QOF Blood Pressure Indicator BP002"
subtitle: |
  Quality and Outcomes Framework Indicators: BP002
date: "`r format(Sys.time(), '%B %d, %Y')`"
bibliography: references.bib
link-citations: true
csl: elsevier-vancouver.csl
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
editor_options: 
  chunk_output_type: inline
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
# Set Rmd options ----
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE)

# Load packages ----
library(ggplot2)
library(magrittr)
library(dplyr)
library(tidyr)
library(here)
library(knitr)
library(readr)
library(purrr)
library(stringr)
library(patchwork)
library(lubridate)
library(gt)

# Load plotting function
source(here::here("lib", "functions", "funs_plot_measures.R"))
source(here::here("lib", "functions", "funs_report_results.R"))
source(here::here("lib", "functions", "funs_tidy_data.R"))
```

```{r load-data, include=FALSE}
# Set file path and load data ----
# Set file path (path starting with output runs summy data)
path_measures_bp002 <- here::here("released_outputs", "measures", "measures_bp002.csv")

# Load data
df_measures_bp002 <- readr::read_csv(path_measures_bp002) %>% 
  select(-value, value = rate) %>% 
  relocate(date, bp002 = event, population, value, group, category)
```

# Introduction

> *The Quality and Outcomes Framework (QOF) is a voluntary annual reward and incentive programme for all GP practices in England* [@NHSDigital2021b].
> *The objective of the Quality and Outcomes Framework (QOF) is to improve the quality of care patients are given by rewarding practices for the quality of care they provide to their patients, based on a number of indicators across a range of key areas of clinical care and public health.* *QOF participation by GP practices is very high, with 96.7% of practices participating in the 2020/21 publication* [@NHSDigital2021a].

OpenSAFELY is a secure analytics platform for electronic patient records built by our group on behalf of NHS England to deliver urgent academic and operational research during the pandemic [e.g., @Curtis2021; @Williamson2020].
Analyses can currently run across all patients' full pseudonymised primary care records, with patient-level linkage to various sources of secondary care data.
The OpenSAFELY-TPP is a Trusted Research Environment (TRE) containing the routine clinical data of 23.4m people, approximately 40% of England's population.

Currently QOF reports are published at the end of the financial year, and consist of prevalence rates and indicator achievement rates for clinical areas by NHS geographic breakdowns from region to practice.
We set out to replicate the indicator logic for a variety of QOF clinical indicators in OpenSAFELY-TPP and describe trends monthly over time, before and during the pandemic.
We also describe how the indicators vary between key clinical, regional and demographic subgroups (e.g., IMD, ethnicity, record of learning disability).
This may help to better understand inequalities in healthcare and highlight potential areas for further research and improvement.

High blood pressure is one of the leading risk factors for several diseases (e.g., cardiovascular disease, stroke) worldwide.
Research suggests that delays in the management of high blood pressure are associated with worse clinical outcomes, for example acute cardiovascular events, or death [@Xu2015a].
This report describes the percentage achievement and counts of QOF blood pressure indicator BP002.

# Methods

Using OpenSAFELY-TPP, covering 40% of England's population, we have evaluated the percentage achievement in QOF blood pressure indicator BP002 between 2019-09-01 and 2022-03-31.

The **study population** for the register was defined following the QOF business rules the (v46) [@NHSDigital2021c].
For each month within the study period, we have calculated the percentage achievement of blood pressure indicator BP002.
All analytical code and output is available for inspection at the [OpenSAFELY GitHub repository](https://github.com/opensafely/blood-pressure-sro).

## Business rules

More details about the rules can be found [here](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/quality-and-outcomes-framework-qof/quality-and-outcome-framework-qof-business-rules/qof-business-rules-v46.0-2021-2022-baseline-release).
Dashboards presenting the annual targets of all QOF indicators published by NHSD are available [here](https://digital.nhs.uk/data-and-information/data-tools-and-services/data-services/general-practice-data-hub/quality-outcomes-framework-qof).

### HYP001 (Register)

The denominator and numerator rules for BP002 (Version: 46.0) are outlined below.

#### Denominator

| Rule number | Rule                                  | Action if true | Action if false | Rule description or comments                                                                                                                                      |
|:--------|:--------|:--------|:--------|:-----------------------------------|
| 1           | If `PAT_AGE` \< 45                    | Reject         | Next rule       | Reject patients from the specified population who are aged less than 45 years old.                                                                                |
| 2           | If `BP_DAT` \> (`PPED` -- 5 years)    | Select         | Next rule       | Select patients passed to this rule who had their blood pressure recorded in the 5 year period leading up to and including the payment period end date.           |
| 3           | If `BPDEC_DAT` \> (`PPED` -- 5 years) | Reject         | Next rule       | Reject patients passed to this rule chose not to have their blood pressure recorded in the 5 year period leading up to and including the payment period end date. |
| 4           | If `REG_DAT` \> (`PPED` -- 3 months)  | Reject         | Select          | Reject patients passed to this rule who registered with the GP practice in the 3 month period leading up to and including the payment period end date.            |

#### Numerator

| Rule number | Rule                               | Action if true | Action if false | Rule description or comments                                                                                                                                                            |
|:--------|:--------|:--------|:--------|:-------------------------------------|
| 1           | If `BP_DAT` \> (`PPED` -- 5 years) | Select         | Reject          | Select patients from the denominator who had their blood pressure recorded in the 5 year period leading up to and including the payment period end date. Reject the remaining patients. |

## Codelists

### Hypertension Refsets

| Cluster name                                                                                             | Description                                                                  | SNOMED CT            |
|:--------------------------------|:-----------------------|:--------------|
| [BP_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/bp_cod/20200812/)       | Blood pressure (BP) recording codes                                          | \^999012731000230108 |
| [BPDEC_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/bpdec_cod/20200812/) | Codes indicating the patient has chosen not to have blood pressure procedure | \^999012611000230106 |

### Breakdowns

| Codelist name                                                                                                                                     | Description                                                                                                    | Coding system |
|:--------------------------------|:------------------------|:-------------|
| [Ethnicity](https://www.opencodelists.org/codelist/opensafely/ethnicity/2020-04-27)                                                               | A list of ethnicity codes in use in UK general practice including aggregate grouping at two levels (6 and 16). | CTV3          |
| [NHS England Care Homes residential status](https://www.opencodelists.org/codelist/opensafely/nhs-england-care-homes-residential-status/3712ef13) | This codelists supports analysis of records of people who may reside in a nursing or care home.                | SNOMED CT     |
| [Learning disabilities](https://www.opencodelists.org/codelist/opensafely/learning-disabilities/2020-07-06)                                       | The following codes are used to indicate learning disability.                                                  | CTV3          |

# Results

Note that the scaling of the y-axis scale is different for the total population (0% to 100%) and breakdowns by subgroups (scaling differs across grouping variables to highlight differences between groups).
All figures are showing the percentage Achievement (Panel A) and the total count (Panel B) for context.
Table 1 shows the register, list size and prevalence of the study population at the end of each financial year (March).

## HYP001 (Register)

```{r tab1-bp002-create-df}
# Create data for table
tab1_measures_bp002 <- df_measures_bp002 %>% 
  filter(month(date) == 3) %>% 
  mutate(date = paste0("march_", year(date))) %>% 
  pivot_wider(id_cols = c(group,
                          category), 
              names_from = date, 
              values_from = c(bp002, 
                              population,
                              value)) %>% 
  arrange(group, category) %>% 
  relocate(group, category, 
           bp002_march_2020, population_march_2020, value_march_2020,
           bp002_march_2021, population_march_2021, value_march_2021,
           bp002_march_2022, population_march_2022, value_march_2022) %>%
  tidy_category_names(group = group,
                      category = category,
                      sex = "sex",
                      population = "population") %>% 
  mutate(group = case_when(group == "age_band" ~ "Age band",
                           group == "care_home_status" ~ "Record of care home status",
                           group == "learning_disability" ~ "Record of learning disability",
                           group == "population" ~ "Population",
                           group == "region" ~ "Region",
                           group == "imd" ~ "IMD",
                           group == "ethnicity" ~ "Ethnicity",
                           group == "sex" ~ "Sex",
                           TRUE ~ group))

```

```{r tab1-bp002}

# Create initial table object
gt_tab1_measures_bp002 <- tab1_measures_bp002 %>% 
  gt(rowname_col = "category",
     groupname_col = "group") %>% 
  tab_header(title = "Demographic breakdowns for QOF BP002 indicator") %>%
  row_group_order(groups = c("Population", "Sex", "Age band", "IMD", "Ethnicity", "Region"))

# Format table
gt_tab1_measures_bp002 %>% 
  tab_spanner(
    label = "FY 2019-20",
    columns = c(bp002_march_2020, population_march_2020, value_march_2020)
  ) %>% 
  tab_spanner(
    label = "FY 2020-21",
    columns = c(bp002_march_2021, population_march_2021, value_march_2021)
  ) %>% 
  tab_spanner(
    label = "FY 2021-22",
    columns = c(bp002_march_2022, population_march_2022, value_march_2022)
  ) %>% 
  fmt_number(
    columns = c(bp002_march_2020, population_march_2020,
                bp002_march_2021, population_march_2021,
                bp002_march_2022, population_march_2022),
    decimals = 0,
    use_seps = TRUE
  ) %>% 
  fmt_percent(
    columns = c(value_march_2020, value_march_2021, value_march_2022),
    decimals = 2,
    use_seps = TRUE
  ) %>% 
  cols_label(
    bp002_march_2020 = "Register",
    population_march_2020 = "List size",
    value_march_2020 = "Achievement",
    bp002_march_2021 = "Register",
    population_march_2021 = "List size",
    value_march_2021 = "Achievement",
    bp002_march_2022 = "Register",
    population_march_2022 = "List size",
    value_march_2022 = "Achievement",
  ) %>% 
  tab_options(
    column_labels.font.size = "small",
    table.font.size = "small",
    row_group.font.size = "small",
    data_row.padding = px(3)
  ) %>% 
  tab_footnote(
    footnote = "The values of the last month of yeach NHS financial year (March) are presented as a summary for each financial year.",
    locations = cells_column_spanners(spanners = everything())
  ) %>% 
  tab_footnote(
    footnote = "This sample was restricted to 'Female' and 'Male'.",
    locations = cells_row_groups(groups = "Sex")
  )
```

### Total population

```{r fig-data}
df_figs_measures_bp002 <- df_measures_bp002 %>% 
  tidy_category_names(group = group,
                      category = category,
                      sex = "sex",
                      population = "population")
```

```{r fig.width=8, fig.height=8}

bp002_population_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "population") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    legend = "none",
    y_label = "Achievement (%)",
    set_y_scale_limits = TRUE
  )

bp002_population_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "population") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    legend = "none",
    y_label = "Achievement (Count)",
    set_y_scale_limits = TRUE
  )

bp002_population_population <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "population") %>%
  plot_qof_indicator(
    value = population,
    group_category = category,
    y_scale = "count",
    y_label = "Population (Count)",
    set_y_scale_limits = TRUE
    )

bp002_count_combined <- (bp002_population_count / bp002_population_population)

p_ranges_y <- c(ggplot_build(bp002_count_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(bp002_count_combined[[2]])$layout$panel_scales_y[[1]]$range$range)

bp002_count_combined <- bp002_count_combined & 
  ggplot2::scale_y_continuous(labels = scales::comma, 
                              limits = c(min(p_ranges_y), max(p_ranges_y)))

bp002_population_pct_count <- (bp002_population_pct / bp002_count_combined) +
  patchwork::plot_layout(guides = 'collect', height = c(1, 2)) &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_population_pct_count.png",
                plot = bp002_population_pct_count,
                width = 8,
                height = 8, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_population_pct_count
```

### Sex

```{r fig.width=8, fig.height=8}

bp002_sex_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "sex") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_dark2"
  )

bp002_sex_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "sex") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_dark2"
  )

bp002_sex_population <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "sex") %>%
  dplyr::filter(category != "missing") %>%
  plot_qof_indicator(
    value = population,
    group_category = category,
    y_scale = "count",
    y_label = "Population (Count)",
    scale_colour = "brewer_dark2"
  )

bp002_count_combined <- (bp002_sex_count / bp002_sex_population)

p_ranges_y <- c(ggplot_build(bp002_count_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(bp002_count_combined[[2]])$layout$panel_scales_y[[1]]$range$range)

bp002_count_combined <- bp002_count_combined & 
  ggplot2::scale_y_continuous(labels = scales::comma, 
                              limits = c(min(p_ranges_y), max(p_ranges_y)))

bp002_sex_pct_count <- (bp002_sex_pct / bp002_count_combined) +
  patchwork::plot_layout(guides = 'collect', height = c(1, 2)) &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_sex_pct_count.png",
                plot = bp002_sex_pct_count,
                width = 8,
                height = 8, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_sex_pct_count
```

### Age band

```{r fig.width=8, fig.height=8}

bp002_age_band_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "age_band") %>%
  dplyr::filter(category != "missing") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)"
  )

bp002_age_band_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "age_band") %>%
  dplyr::filter(category != "missing") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)"
  )

bp002_age_band_population <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "age_band") %>%
  dplyr::filter(category != "missing") %>%
  plot_qof_indicator(
    value = population,
    group_category = category,
    y_scale = "count",
    y_label = "Population (Count)"
  )

bp002_count_combined <- (bp002_age_band_count / bp002_age_band_population)

p_ranges_y <- c(ggplot_build(bp002_count_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(bp002_count_combined[[2]])$layout$panel_scales_y[[1]]$range$range)

bp002_count_combined <- bp002_count_combined & 
  ggplot2::scale_y_continuous(labels = scales::comma, 
                              limits = c(min(p_ranges_y), max(p_ranges_y)))

bp002_age_band_pct_count <- (bp002_age_band_pct / bp002_count_combined) +
  patchwork::plot_layout(guides = 'collect', height = c(1, 2)) &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_age_band_pct_count.png",
                plot = bp002_age_band_pct_count,
                width = 8,
                height = 8, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_age_band_pct_count
```

### IMD

```{r fig.width=8, fig.height=8}

bp002_imd_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "imd") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)"
  )

bp002_imd_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "imd") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)"
  )

bp002_imd_population <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "imd") %>%
  plot_qof_indicator(
    value = population,
    group_category = category,
    y_scale = "count",
    y_label = "Population (Count)"
  )

bp002_count_combined <- (bp002_imd_count / bp002_imd_population)

p_ranges_y <- c(ggplot_build(bp002_count_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(bp002_count_combined[[2]])$layout$panel_scales_y[[1]]$range$range)

bp002_count_combined <- bp002_count_combined & 
  ggplot2::scale_y_continuous(labels = scales::comma, 
                              limits = c(min(p_ranges_y), max(p_ranges_y)))

bp002_imd_pct_count <- (bp002_imd_pct / bp002_count_combined) +
  patchwork::plot_layout(guides = 'collect', height = c(1, 2)) &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_imd_pct_count.png",
                plot = bp002_imd_pct_count,
                width = 8,
                height = 8, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_imd_pct_count
```

### Ethnicity

```{r fig.width=8, fig.height=8}

bp002_ethnicity_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "ethnicity") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_set1"
  )

bp002_ethnicity_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "ethnicity") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_set1"
  )

bp002_ethnicity_population <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "ethnicity") %>%
  plot_qof_indicator(
    value = population,
    group_category = category,
    y_scale = "count",
    y_label = "Population (Count)",
    scale_colour = "brewer_set1"
  )

bp002_count_combined <- (bp002_ethnicity_count / bp002_ethnicity_population)

p_ranges_y <- c(ggplot_build(bp002_count_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(bp002_count_combined[[2]])$layout$panel_scales_y[[1]]$range$range)

bp002_count_combined <- bp002_count_combined & 
  ggplot2::scale_y_continuous(labels = scales::comma, 
                              limits = c(min(p_ranges_y), max(p_ranges_y)))

bp002_ethnicity_pct_count <- (bp002_ethnicity_pct / bp002_count_combined) +
  patchwork::plot_layout(guides = 'collect', height = c(1, 2)) &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_ethnicity_pct_count.png",
                plot = bp002_ethnicity_pct_count,
                width = 8,
                height = 8, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_ethnicity_pct_count
```

### Region

```{r fig.width=8, fig.height=8}

bp002_region_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "region") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_set1"
  )

bp002_region_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "region") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_set1"
  )

bp002_region_population <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "region") %>%
  plot_qof_indicator(
    value = population,
    group_category = category,
    y_scale = "count",
    y_label = "Population (Count)",
    scale_colour = "brewer_set1"
  )

bp002_count_combined <- (bp002_region_count / bp002_region_population)

p_ranges_y <- c(ggplot_build(bp002_count_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(bp002_count_combined[[2]])$layout$panel_scales_y[[1]]$range$range)

bp002_count_combined <- bp002_count_combined & 
  ggplot2::scale_y_continuous(labels = scales::comma, 
                              limits = c(min(p_ranges_y), max(p_ranges_y)))

bp002_region_pct_count <- (bp002_region_pct / bp002_count_combined) +
  patchwork::plot_layout(guides = 'collect', height = c(1, 2)) &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_region_pct_count.png",
                plot = bp002_region_pct_count,
                width = 8,
                height = 8, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_region_pct_count
```

### Learning disability

```{r fig.width=8, fig.height=8}

bp002_learning_disability_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "learning_disability") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_dark2"
  )

bp002_learning_disability_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "learning_disability") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_dark2"
  )

bp002_learning_disability_population <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "learning_disability") %>%
  plot_qof_indicator(
    value = population,
    group_category = category,
    y_scale = "count",
    y_label = "Population (Count)",
    scale_colour = "brewer_dark2"
  )

bp002_count_combined <- (bp002_learning_disability_count / bp002_learning_disability_population)

p_ranges_y <- c(ggplot_build(bp002_count_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(bp002_count_combined[[2]])$layout$panel_scales_y[[1]]$range$range)

bp002_count_combined <- bp002_count_combined & 
  ggplot2::scale_y_continuous(labels = scales::comma, 
                              limits = c(min(p_ranges_y), max(p_ranges_y)))

bp002_learning_disability_pct_count <- (bp002_learning_disability_pct / bp002_count_combined) +
  patchwork::plot_layout(guides = 'collect', height = c(1, 2)) &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_learning_disability_pct_count.png",
                plot = bp002_learning_disability_pct_count,
                width = 8,
                height = 8, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_learning_disability_pct_count
```

### Care home status

```{r fig.width=8, fig.height=8}

bp002_care_home_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "care_home_status") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_dark2"
  )

bp002_care_home_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "care_home_status") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_dark2"
  )

bp002_care_home_population <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "care_home_status") %>%
  plot_qof_indicator(
    value = population,
    group_category = category,
    y_scale = "count",
    y_label = "Population (Count)",
    scale_colour = "brewer_dark2"
  )

bp002_count_combined <- (bp002_care_home_count / bp002_care_home_population)

p_ranges_y <- c(ggplot_build(bp002_count_combined[[1]])$layout$panel_scales_y[[1]]$range$range,
                ggplot_build(bp002_count_combined[[2]])$layout$panel_scales_y[[1]]$range$range)

bp002_count_combined <- bp002_count_combined & 
  ggplot2::scale_y_continuous(labels = scales::comma, 
                              limits = c(min(p_ranges_y), max(p_ranges_y)))

bp002_care_home_pct_count <- (bp002_care_home_pct / bp002_count_combined) +
  patchwork::plot_layout(guides = 'collect', height = c(1, 2)) &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_care_home_pct_count.png",
                plot = bp002_care_home_pct_count,
                width = 8,
                height = 8, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_care_home_pct_count
```

# Discussion

# References
