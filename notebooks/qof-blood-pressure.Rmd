---
title: "Trends in QOF Blood Pressure Indicator BP002"
subtitle: |
  Quality and Outcomes Framework Indicators: BP002
date: "`r format(Sys.time(), '%B %d, %Y')`"
# author:
#   - first_name: "Milan"
#     last_name: "Wiedemann"
#     url: https://www.bennett.ox.ac.uk/about-us/milan-wiedemann
#     affiliation: Bennett Institute for Applied Data Science
#     affiliation_url: https://www.bennett.ox.ac.uk/
#     orcid_id: 0000-0003-1991-282X
#   - first_name: "Rose"
#     last_name: "Higgins"
#     url: https://www.bennett.ox.ac.uk/about-us/rose-higgins/
#     affiliation: Bennett Institute for Applied Data Science
#     affiliation_url: https://www.bennett.ox.ac.uk/
#     orcid_id: 0000-0002-5295-4370
#   - first_name: "Christine"
#     last_name: "Cunningham"
#     url: https://www.bennett.ox.ac.uk/about-us/christine-cunningham/
#     affiliation: Bennett Institute for Applied Data Science
#     affiliation_url: https://www.bennett.ox.ac.uk/
#   - first_name: "AND everyone else"
#     last_name: "(just QOF workgroup for now)"
#     url: https://www.bennett.ox.ac.uk/about-us/
#     affiliation: Bennett Institute for Applied Data Science
#     affiliation_url: https://www.bennett.ox.ac.uk/
#   - first_name: "Brian"
#     last_name: "MacKenna"
#     url: https://www.bennett.ox.ac.uk/about-us/brian-mackenna/
#     affiliation: Bennett Institute for Applied Data Science
#     affiliation_url: https://www.bennett.ox.ac.uk/
#     orcid_id: 0000-0002-3786-9063
bibliography: references.bib
link-citations: true
csl: elsevier-vancouver.csl
# output: 
#   distill::distill_article:
#     toc: true
#     code_folding: true
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
# Set Rmd options ----
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE, 
                      cache = TRUE, 
                      R.options = list(width = 70), 
                      layout="l-body-outset")

# Load packages ----
library(ggplot2)
library(magrittr)
library(dplyr)
library(tidyr)
library(here)
library(knitr)
library(readr)
library(purrr)
library(stringr)
library(patchwork)
library(lubridate)
library(gt)

# Load plotting function
source(here::here("lib", "functions", "funs_plot_measures.R"))
source(here::here("lib", "functions", "funs_report_results.R"))
source(here::here("lib", "functions", "funs_tidy_data.R"))
```

```{r load-data, include=FALSE}
# Set file path and load data ----
# Set file path (path starting with output runs summy data)
path_measures_bp002 <- here::here("released_outputs", "measures", "measures_bp002.csv")

# Load data
df_measures_bp002 <- readr::read_csv(path_measures_bp002) %>% 
  select(-value, value = rate) %>% 
  relocate(date, bp002 = event, population, value, group, category)
```

# Introduction

> *The Quality and Outcomes Framework (QOF) is a voluntary annual reward and incentive programme for all GP practices in England* [@NHSDigital2021b].
> *The objective of the Quality and Outcomes Framework (QOF) is to improve the quality of care patients are given by rewarding practices for the quality of care they provide to their patients, based on a number of indicators across a range of key areas of clinical care and public health.* *QOF participation by GP practices is very high, with 96.7% of practices participating in the 2020/21 publication* [@NHSDigital2021a].

OpenSAFELY is a secure analytics platform for electronic patient records built by our group on behalf of NHS England to deliver urgent academic and operational research during the pandemic [e.g., @Curtis2021; @Williamson2020].
Analyses can currently run across all patients' full pseudonymised primary care records, with patient-level linkage to various sources of secondary care data.
The OpenSAFELY-TPP is a Trusted Research Environment (TRE) containing the routine clinical data of 23.4m people, approximately 40% of England's population.

Currently QOF reports are published at the end of the financial year, and consist of prevalence rates and indicator achievement rates for clinical areas by NHS geographic breakdowns from region to practice.
We set out to replicate the indicator logic for a variety of QOF clinical indicators in OpenSAFELY-TPP and describe trends monthly over time, before and during the pandemic.
We also describe how the indicators vary between key clinical, regional and demographic subgroups (e.g., IMD, ethnicity, record of learning disability).
This may help to better understand inequalities in healthcare and highlight potential areas for further research and improvement.

High blood pressure is one of the leading risk factors for several diseases (e.g., cardiovascular disease, stroke) worldwide.
Research suggests that delays in the management of high blood pressure are associated with worse clinical outcomes, for example acute cardiovascular events, or death [@Xu2015a].
This report describes the percentage achievement and counts of QOF blood pressure indicator BP002.

# Methods

Using OpenSAFELY-TPP, covering 40% of England's population, we have evaluated the percentage achievement in QOF blood pressure indicator BP002 between 2019-09-01 and 2022-03-31.

The **study population** for the register was defined following the QOF business rules the (v46) [@NHSDigital2021c].
For each month within the study period, we have calculated the percentage achievement of blood pressure indicator BP002.
All analytical code and output is available for inspection at the [OpenSAFELY GitHub repository](https://github.com/opensafely/blood-pressure-sro).

## Business rules

More details about the rules can be found [here](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/quality-and-outcomes-framework-qof/quality-and-outcome-framework-qof-business-rules/qof-business-rules-v46.0-2021-2022-baseline-release).
Dashboards presenting the annual targets of all QOF indicators published by NHSD are available [here](https://digital.nhs.uk/data-and-information/data-tools-and-services/data-services/general-practice-data-hub/quality-outcomes-framework-qof).

### HYP001 (Register)

The description and rules for the Hypertension Register (HYP001, Version: 46.0) are outlined below:

> "Select patients from the specified population who have a diagnosis of hypertension which has not been subsequently resolved."

| Rule number | Rule                                              | Action if true | Action if false | Rule description or comments                                                                                                                                |
|:-----------|:-----------|:-----------|:-----------|:-------------------------|
| 1           | If `HYPLAT_DAT` â‰  Null AND If `HYPRES_DAT` = Null | Select         | Reject          | Select patients from the specified population who have a diagnosis of hypertension which has not been subsequently resolved. Reject the remaining patients. |

## Codelists

### Hypertension Refsets

| Cluster name                                                                                            | Description                                                                                | SNOMED CT            |
|:----------------------------|:-------------------------|:----------------|
| [BP_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/bp_cod/)               | Blood pressure (BP) recording codes                                                        | \^999012731000230108 |
| [BPDEC_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/bpdec_cod/)         | Codes indicating the patient has chosen not to have blood pressure procedure               | \^999012611000230106 |
| [HTMAX_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/htmax_cod/)         | Codes for maximal blood pressure (BP) therapy                                              | \^999006651000230109 |
| [HYP_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hyp_cod/)             | Hypertension diagnosis codes                                                               | \^999006611000230105 |
| [HYPINVITE_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hypinvite_cod/) | Invite for hypertension care review codes                                                  | \^999012971000230108 |
| [HYPPCADEC_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hyppcadec_cod/) | Codes indicating the patient has chosen not to receive hypertension quality indicator care | \^999013091000230102 |
| [HYPPCAPU_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hyppcapu_cod/)   | Codes for hypertension quality indicator care unsuitable for patient                       | \^999013211000230104 |
| [HYPRES_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hypres_cod/)       | Hypertension resolved codes                                                                | \^999006531000230101 |

### Breakdowns

| Codelist name                                                                                                                                     | Description                                                                                                    | Coding system |
|:------------------------------|:-----------------------|:----------------|
| [Ethnicity](https://www.opencodelists.org/codelist/opensafely/ethnicity/2020-04-27)                                                               | A list of ethnicity codes in use in UK general practice including aggregate grouping at two levels (6 and 16). | CTV3          |
| [NHS England Care Homes residential status](https://www.opencodelists.org/codelist/opensafely/nhs-england-care-homes-residential-status/3712ef13) | This codelists supports analysis of records of people who may reside in a nursing or care home.                | SNOMED CT     |
| [Learning disability (LD) codes](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/ld_cod/)                                 | The following codes are used to check for a record of learning disability.                                     | SNOMED CT     |

# Results

Note that the scaling of the y-axis scale is different for the total population (0% to 100%) and breakdowns by subgroups (scaling differs across grouping variables to highlight differences between groups).
All figures are showing the percentage Achievement (Panel A) and the total count (Panel B) for context.
Table 1 shows the register, list size and prevalence of the study population at the end of each financial year (March).

## HYP001 (Register)

```{r tab1-bp002-create-df}
# Create data for table
tab1_measures_bp002 <- df_measures_bp002 %>% 
  filter(month(date) == 3) %>% 
  mutate(date = paste0("march_", year(date))) %>% 
  pivot_wider(id_cols = c(group,
                          category), 
              names_from = date, 
              values_from = c(bp002, 
                              population,
                              value)) %>% 
  arrange(group, category) %>% 
  relocate(group, category, 
           bp002_march_2020, population_march_2020, value_march_2020,
           bp002_march_2021, population_march_2021, value_march_2021,
           bp002_march_2022, population_march_2022, value_march_2022) %>%
  tidy_category_names(group = group,
                      category = category,
                      sex = "sex",
                      population = "population") %>% 
  mutate(group = case_when(group == "age_band" ~ "Age band",
                           group == "care_home_status" ~ "Record of care home status",
                           group == "learning_disability" ~ "Record of learning disability",
                           group == "population" ~ "Population",
                           group == "region" ~ "Region",
                           group == "imd" ~ "IMD",
                           group == "ethnicity" ~ "Ethnicity",
                           group == "sex" ~ "Sex",
                           TRUE ~ group))

```


```{r tab1-bp002}

# Create initial table object
gt_tab1_measures_bp002 <- tab1_measures_bp002 %>% 
  gt(rowname_col = "category",
     groupname_col = "group") %>% 
  tab_header(title = "Demographic breakdowns for QOF BP002 indicator") %>%
  row_group_order(groups = c("Population", "Sex", "Age band", "IMD", "Ethnicity", "Region"))

# Format table
gt_tab1_measures_bp002 %>% 
  tab_spanner(
    label = "FY 2019-20",
    columns = c(bp002_march_2020, population_march_2020, value_march_2020)
  ) %>% 
  tab_spanner(
    label = "FY 2020-21",
    columns = c(bp002_march_2021, population_march_2021, value_march_2021)
  ) %>% 
  tab_spanner(
    label = "FY 2021-22",
    columns = c(bp002_march_2022, population_march_2022, value_march_2022)
  ) %>% 
  fmt_number(
    columns = c(bp002_march_2020, population_march_2020,
                bp002_march_2021, population_march_2021,
                bp002_march_2022, population_march_2022),
    decimals = 0,
    use_seps = TRUE
  ) %>% 
  fmt_percent(
    columns = c(value_march_2020, value_march_2021, value_march_2022),
    decimals = 2,
    use_seps = TRUE
  ) %>% 
  cols_label(
    bp002_march_2020 = "Register",
    population_march_2020 = "List size",
    value_march_2020 = "Achievement",
    bp002_march_2021 = "Register",
    population_march_2021 = "List size",
    value_march_2021 = "Achievement",
    bp002_march_2022 = "Register",
    population_march_2022 = "List size",
    value_march_2022 = "Achievement",
  ) %>% 
  tab_options(
    column_labels.font.size = "small",
    table.font.size = "small",
    row_group.font.size = "small",
    data_row.padding = px(3)
  ) %>% 
  tab_footnote(
    footnote = "The values of the last month of yeach NHS financial year (March) are presented as a summary for each financial year.",
    locations = cells_column_spanners(spanners = everything())
  ) %>% 
  tab_footnote(
    footnote = "This sample was restricted to 'Female' and 'Male'.",
    locations = cells_row_groups(groups = "Sex")
  )
```

### Total population

```{r fig-data}
df_figs_measures_bp002 <- df_measures_bp002 %>% 
  tidy_category_names(group = group,
                      category = category,
                      sex = "sex",
                      population = "population")
```


```{r fig.width=8, fig.height=6.5}


bp002_population_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "population") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    legend = "none",
    y_label = "Achievement (%)",
    set_y_scale_limits = TRUE
  )

bp002_population_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "population") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    legend = "none",
    y_label = "Achievement (Count)",
    set_y_scale_limits = TRUE
  )

bp002_population_pct_count <- (bp002_population_pct / bp002_population_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A')

# Save plot
ggplot2::ggsave(filename = "bp002_population_pct_count.png",
                plot = bp002_population_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )
# Show plot
bp002_population_pct_count
```

### Sex

```{r fig.width=8, fig.height=6.5}

bp002_sex_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "sex") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_dark2"
  )

bp002_sex_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "sex") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_dark2"
  )

bp002_sex_pct_count <- (bp002_sex_pct / bp002_sex_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_sex_pct_count.png",
                plot = bp002_sex_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_sex_pct_count
```

### Age band

```{r fig.width=8, fig.height=6.5}

bp002_age_band_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "age_band") %>%
  dplyr::filter(category != "missing") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)"
  )

bp002_age_band_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "age_band") %>%
  dplyr::filter(category != "missing") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)"
  )

bp002_age_band_pct_count <- (bp002_age_band_pct / bp002_age_band_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_age_band_pct_count.png",
                plot = bp002_age_band_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_age_band_pct_count
```

### IMD

```{r fig.width=8, fig.height=6.5}

bp002_imd_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "imd") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)"
  )

bp002_imd_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "imd") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)"
  )

bp002_imd_pct_count <- (bp002_imd_pct / bp002_imd_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_imd_pct_count.png",
                plot = bp002_imd_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_imd_pct_count
```

### Ethnicity

```{r fig.width=8, fig.height=6.5}

bp002_ethnicity_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "ethnicity") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_set1"
  )

bp002_ethnicity_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "ethnicity") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_set1"
  )

bp002_ethnicity_pct_count <- (bp002_ethnicity_pct / bp002_ethnicity_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_ethnicity_pct_count.png",
                plot = bp002_ethnicity_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_ethnicity_pct_count
```

### Region

```{r fig.width=8, fig.height=6.5}

bp002_region_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "region") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_set1"
  )

bp002_region_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "region") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_set1"
  )

bp002_region_pct_count <- (bp002_region_pct / bp002_region_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_region_pct_count.png",
                plot = bp002_region_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_region_pct_count
```

### Learning disability

```{r fig.width=8, fig.height=6.5}

bp002_learning_disability_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "learning_disability") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_dark2"
  )

bp002_learning_disability_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "learning_disability") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_dark2"
  )

bp002_learning_disability_pct_count <- (bp002_learning_disability_pct / bp002_learning_disability_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_learning_disability_pct_count.png",
                plot = bp002_learning_disability_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_learning_disability_pct_count
```

### Care home status

```{r fig.width=8, fig.height=6.5}

bp002_care_home_pct <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "care_home_status") %>%
  plot_qof_indicator(
    value = value,
    group_category = category,
    y_scale = "percent",
    y_label = "Achievement (%)",
    scale_colour = "brewer_dark2"
  )

bp002_care_home_count <- df_figs_measures_bp002 %>%
  dplyr::filter(group == "care_home_status") %>%
  plot_qof_indicator(
    value = bp002,
    group_category = category,
    y_scale = "count",
    y_label = "Achievement (Count)",
    scale_colour = "brewer_dark2"
  )

bp002_care_home_pct_count <- (bp002_care_home_pct / bp002_care_home_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "bp002_care_home_pct_count.png",
                plot = bp002_care_home_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )

bp002_care_home_pct_count
```

# Discussion

<!-- For hypertension we found a prevalence of  -->
<!-- `r report_measures(df_measures_bp002, var_value = value, filter_date = "2019-03-01", filter_group = "population", filter_category = "population")` in March 2019,  -->
<!-- `r report_measures(df_measures_bp002, var_value = value, filter_date = "2020-03-01", filter_group = "population", filter_category = "population")` in March 2020, and  -->
<!-- `r report_measures(df_measures_bp002, var_value = value, filter_date = "2021-03-01", filter_group = "population", filter_category = "population")` in March 2021. -->
<!-- Overall, we observed a small gradual decline in hypertension prevalence over time, with the biggest drop from March to April 2020 (12580 patients). -->
<!-- Our results are very similar to the hypertension prevalence recorded by NHS Digital in 2019-22 (14.1%) and 2020-21 (13.9%) [@NHSDigital2021d]. -->

<!-- df_measures_bp002 %>% filter(category == "population") %>% mutate(lag_hyp = hypertension - lag(hypertension)) %>% arrange(lag_hyp) -->

<!-- Observed differences in prevalence count and percentage across the subgroups were mainly as expected. -->
<!-- For example, while age group 80+ has the highest prevalence, age groups 60-69 and 70-79 are larger in size. -->
<!-- The largest difference between subgroups was observed between patients with and without a record of  -->
<!-- learning disability ( -->
<!-- Yes: `r report_measures(df_measures_bp002, var_value = value, filter_date = "2019-03-01", filter_group = "learning_disability", filter_category = TRUE)`;  -->
<!-- No: `r report_measures(df_measures_bp002, var_value = value, filter_date = "2019-03-01", filter_group = "learning_disability", filter_category = FALSE)`) and  -->
<!-- care home status ( -->
<!-- Yes: `r report_measures(df = df_measures_bp002, var_value = value, filter_date = "2019-03-01", filter_group = "care_home", filter_category = TRUE)`;  -->
<!-- No: `r report_measures(df = df_measures_bp002, var_value = value, filter_date = "2019-03-01", filter_group = "care_home", filter_category = FALSE)`) and  -->
<!-- for age bands 40-49 and lower compared with age bands 50-59 and higher. -->

<!-- - TODO: Add how this relates to the pandemic -->
<!-- - TODO: Add advantages of analysing QOF in OpenSAFELY  -->
<!--   - e.g., monthly changes compared to annual average -->
<!--   - e.g., modular code that can be reused and adapted for other research projects -->

# References
